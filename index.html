<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mental Math</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Mental Math</h1>
    <div class="divider"><div id="timer-progress" class="timer-progress"></div></div>

    <div id="start-screen">
      <p>Solve as many problems as you can in 2 minutes.</p>
      <p class="level">Level: <span id="current-level">1</span> <span id="level-delta"></span></p>
      <p id="high-score" class="high-score">High score: <span id="high-score-value">0</span></p>
      <p id="last-score" class="last-score hidden">Last score: <span id="last-score-value">0</span></p>
      <button onclick="startGame()">Start</button>
      <div id="debug-toggle" class="debug">
        <label><input type="checkbox" id="debug-checkbox" onchange="toggleDebug()"> Debug mode</label>
      </div>
    </div>

    <div id="game-screen" class="hidden">
      <div class="problem"><span id="problem-text">0 + 0</span> = ?</div>
      <input type="number" id="answer" autofocus oninput="checkAnswer()">
      <div class="score hidden">Score: <span id="score">0</span></div>
      <div id="debug-panel" class="debug">
        <span class="debug-label">DEBUG</span>
        <div>Addition: <span id="debug-addition">1.0</span></div>
        <div>Subtraction: <span id="debug-subtraction">1.0</span></div>
        <div><span id="debug-delta"></span></div>
        <div class="debug-controls">
          <button onclick="adjustDifficulty(-1)" class="debug-btn">-1</button>
          <button onclick="adjustDifficulty(1)" class="debug-btn">+1</button>
          <button onclick="endGame()" class="debug-btn">End Game</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let score = 0;
    let timeLeft = 30;
    let timer = null;
    let numbers = [];
    let correctAnswer = 0;
    let currentOperation = '+';
    let additionDifficulty = parseFloat(localStorage.getItem('additionLevel')) || 1.0;
    let subtractionDifficulty = parseFloat(localStorage.getItem('subtractionLevel')) || 1.0;
    let highScore = parseInt(localStorage.getItem('highScore')) || 0;
    let startingAdditionDifficulty = additionDifficulty;
    let startingSubtractionDifficulty = subtractionDifficulty;
    let currentPuzzleDifficulty = 1.0;
    let problemStartTime = 0;
    let DEBUG = localStorage.getItem('debugMode') === 'true';
    const TARGET_TIME = 4;
    const GAME_DURATION = 60;

    // Initialize debug checkbox
    document.getElementById('debug-checkbox').checked = DEBUG;

    function toggleDebug() {
      DEBUG = document.getElementById('debug-checkbox').checked;
      localStorage.setItem('debugMode', DEBUG);
    }

    function getAverageLevel() {
      return (additionDifficulty + subtractionDifficulty) / 2;
    }

    function getCurrentDifficulty() {
      return currentOperation === '+' ? additionDifficulty : subtractionDifficulty;
    }

    // Initialize level display
    updateLevelDisplay();
    document.getElementById('high-score-value').textContent = highScore;

    function startGame() {
      score = 0;
      timeLeft = 60;
      startingAdditionDifficulty = additionDifficulty;
      startingSubtractionDifficulty = subtractionDifficulty;

      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');

      document.getElementById('score').textContent = score;
      document.getElementById('timer-progress').style.transition = 'width 1s linear';
      updateTimerBar();

      // Debug panel visibility
      document.getElementById('debug-panel').classList.toggle('hidden', !DEBUG);
      updateDebug();

      generateProblem();
      document.getElementById('answer').focus();

      if (!DEBUG) {
        timer = setInterval(() => {
          timeLeft--;
          updateTimerBar();

          if (timeLeft <= 0) {
            endGame();
          }
        }, 1000);
      }
    }

    function generateProblem() {
      // Randomly pick operation
      currentOperation = Math.random() < 0.5 ? '+' : '-';
      const difficulty = getCurrentDifficulty();

      // 10% chance of easy problem
      const isEasyProblem = Math.random() < 0.1;
      currentPuzzleDifficulty = isEasyProblem ? 1.0 : difficulty;

      const minNum = 1 + Math.floor(currentPuzzleDifficulty);
      const maxNum = 5 + Math.floor(currentPuzzleDifficulty * 2);

      // Generate first number (scales with difficulty)
      let num1 = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;

      // Second number has wider range (1 to max)
      let num2 = Math.floor(Math.random() * maxNum) + 1;

      numbers = [num1, num2];

      if (currentOperation === '+') {
        // Addition-specific modifiers
        // 10% chance: three-number addition
        if (Math.random() < 0.1) {
          const num3 = Math.floor(Math.random() * maxNum) + 1;
          numbers.push(num3);
        }

        // 10% chance: challenge multiplier (double one number)
        if (Math.random() < 0.1) {
          const idx = Math.floor(Math.random() * numbers.length);
          numbers[idx] = numbers[idx] * 2;
        }

        // 10% chance: round number anchor (replace one number with round number)
        if (Math.random() < 0.1) {
          const roundNumbers = [10, 20, 25, 50, 100].filter(n => n <= maxNum * 2);
          if (roundNumbers.length > 0) {
            const idx = Math.floor(Math.random() * numbers.length);
            numbers[idx] = roundNumbers[Math.floor(Math.random() * roundNumbers.length)];
          }
        }

        correctAnswer = numbers.reduce((sum, n) => sum + n, 0);
        document.getElementById('problem-text').textContent = numbers.join(' + ');
      } else {
        // Subtraction: ensure positive result (larger - smaller)
        // 10% chance: challenge multiplier (double one number)
        if (Math.random() < 0.1) {
          const idx = Math.floor(Math.random() * numbers.length);
          numbers[idx] = numbers[idx] * 2;
        }

        // 10% chance: round number anchor
        if (Math.random() < 0.1) {
          const roundNumbers = [10, 20, 25, 50, 100].filter(n => n <= maxNum * 2);
          if (roundNumbers.length > 0) {
            const idx = Math.floor(Math.random() * numbers.length);
            numbers[idx] = roundNumbers[Math.floor(Math.random() * roundNumbers.length)];
          }
        }

        // Sort descending to ensure positive result
        numbers.sort((a, b) => b - a);
        correctAnswer = numbers[0] - numbers[1];
        document.getElementById('problem-text').textContent = numbers[0] + ' - ' + numbers[1];
      }

      document.getElementById('answer').value = '';
      problemStartTime = Date.now();
    }

    function checkAnswer() {
      const answer = parseInt(document.getElementById('answer').value);
      if (answer === correctAnswer) {
        const elapsed = (Date.now() - problemStartTime) / 1000;
        const difficulty = getCurrentDifficulty();

        // Smooth difficulty adjustment
        const puzzleRatio = currentPuzzleDifficulty / difficulty;
        const timeDelta = elapsed - TARGET_TIME; // negative = fast, positive = slow
        const timeMultiplier = Math.max(-1, Math.min(1, -timeDelta / 3));
        const baseAdjustment = 0.25 * timeMultiplier;

        let delta = 0;
        if (baseAdjustment > 0) {
          // Only increase difficulty if puzzle was at least half current difficulty
          if (puzzleRatio >= 0.5) {
            delta = baseAdjustment * puzzleRatio;
          }
        } else {
          // Always allow decreases
          delta = baseAdjustment;
        }

        // Apply delta to correct difficulty
        if (currentOperation === '+') {
          additionDifficulty = Math.max(1.0, additionDifficulty + delta);
        } else {
          subtractionDifficulty = Math.max(1.0, subtractionDifficulty + delta);
        }
        updateDebug(delta);

        // Score based on difficulty
        score += Math.floor(difficulty);
        document.getElementById('score').textContent = score;

        generateProblem();
      }
    }

    let debugDeltaTimeout = null;

    function updateDebug(delta = null) {
      if (!DEBUG) return;
      document.getElementById('debug-addition').textContent = additionDifficulty.toFixed(1);
      document.getElementById('debug-subtraction').textContent = subtractionDifficulty.toFixed(1);

      if (delta !== null && delta !== 0) {
        const deltaEl = document.getElementById('debug-delta');
        const sign = delta > 0 ? '+' : '';
        deltaEl.textContent = '(' + currentOperation + ') ' + sign + delta.toFixed(2);
        deltaEl.classList.add('visible');

        clearTimeout(debugDeltaTimeout);
        debugDeltaTimeout = setTimeout(() => {
          deltaEl.classList.remove('visible');
        }, 800);
      }
    }

    function updateLevelDisplay() {
      document.getElementById('current-level').textContent = Math.floor(getAverageLevel());
    }

    function updateTimerBar() {
      const percentage = (timeLeft / GAME_DURATION) * 100;
      document.getElementById('timer-progress').style.width = percentage + '%';
    }

    function adjustDifficulty(amount) {
      if (currentOperation === '+') {
        additionDifficulty = Math.max(1.0, additionDifficulty + amount);
      } else {
        subtractionDifficulty = Math.max(1.0, subtractionDifficulty + amount);
      }
      updateDebug(amount);
      generateProblem();
      document.getElementById('answer').focus();
    }

    function endGame() {
      clearInterval(timer);
      localStorage.setItem('additionLevel', additionDifficulty.toFixed(2));
      localStorage.setItem('subtractionLevel', subtractionDifficulty.toFixed(2));
      updateLevelDisplay();

      // Show level change (whole numbers only, based on average)
      const oldLevel = Math.floor((startingAdditionDifficulty + startingSubtractionDifficulty) / 2);
      const newLevel = Math.floor(getAverageLevel());
      const levelDelta = newLevel - oldLevel;
      const deltaEl = document.getElementById('level-delta');
      if (levelDelta !== 0) {
        const sign = levelDelta > 0 ? '+' : '';
        deltaEl.textContent = sign + levelDelta;
        deltaEl.className = levelDelta > 0 ? 'delta-up' : 'delta-down';
      } else {
        deltaEl.textContent = '';
      }

      // Update high score if beaten
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('highScore', highScore);
        document.getElementById('high-score-value').textContent = highScore;
      }

      const timerEl = document.getElementById('timer-progress');
      timerEl.style.transition = 'none';
      timerEl.style.width = '100%';
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
      document.getElementById('last-score-value').textContent = score;
      document.getElementById('last-score').classList.remove('hidden');
    }
  </script>
</body>
</html>
