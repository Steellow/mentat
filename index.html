<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mentat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <nav class="nav-icons">
      <a href="stats.html" title="Stats">▦</a>
      <a href="settings.html" title="Settings">⚙</a>
    </nav>
    <h1>mentat</h1>
    <div class="divider"><div id="timer-progress" class="timer-progress"></div></div>

    <div id="start-screen">
      <p>Solve as many problems as you can in 1 minute. Difficulty increases automatically (if you're fast).</p>
      <p class="level">Level: <span id="current-level">1</span> <span id="current-title" class="title" onclick="toggleTitlePopup()">(noob)</span> <span id="level-delta"></span></p>
      <div id="title-popup" class="stats-popup hidden">
        <div class="popup-header">Titles <span class="popup-close" onclick="toggleTitlePopup()">×</span></div>
        <table id="title-table" class="title-table"></table>
      </div>
      <p id="last-score" class="last-score hidden">Last score: <span id="last-score-value">0</span> <span id="new-record" class="new-record hidden">New record!</span> <span id="stats-icon" class="stats-icon" onclick="toggleStatsPopup()">▦</span></p>
      <div id="stats-popup" class="stats-popup hidden">
        <div class="popup-header">Response Times <span class="popup-close" onclick="toggleStatsPopup()">×</span></div>
        <pre id="stats-chart"></pre>
      </div>
      <p class="high-score">High score: <span id="high-score-value">0</span></p>
      <button onclick="startGame()">Start</button>
      <p class="mantra">it is by will alone i set my mind in motion</p>
    </div>

    <div id="game-screen" class="hidden">
      <div class="problem"><span id="problem-text">0 + 0</span> = ?</div>
      <input type="text" id="answer" inputmode="numeric" autofocus oninput="checkAnswer()" onkeydown="handleKeyBinding(event)">
      <div class="score hidden">Score: <span id="score">0</span></div>
      <div id="debug-panel" class="debug">
        <span class="debug-label">DEBUG</span>
        <div class="debug-row">
          <label><input type="checkbox" id="debug-addition-enabled" checked></label>
          <span>Addition: <span id="debug-addition">1.0</span></span>
          <button onclick="adjustDifficulty(-1, '+')" class="debug-btn-sm">-</button>
          <button onclick="adjustDifficulty(1, '+')" class="debug-btn-sm">+</button>
        </div>
        <div class="debug-row">
          <label><input type="checkbox" id="debug-subtraction-enabled" checked></label>
          <span>Subtraction: <span id="debug-subtraction">1.0</span></span>
          <button onclick="adjustDifficulty(-1, '-')" class="debug-btn-sm">-</button>
          <button onclick="adjustDifficulty(1, '-')" class="debug-btn-sm">+</button>
        </div>
        <div class="debug-row">
          <label><input type="checkbox" id="debug-multiplication-enabled" checked></label>
          <span>Multiplication: <span id="debug-multiplication">1.0</span></span>
          <button onclick="adjustDifficulty(-1, '×')" class="debug-btn-sm">-</button>
          <button onclick="adjustDifficulty(1, '×')" class="debug-btn-sm">+</button>
        </div>
        <div class="debug-row">
          <label><input type="checkbox" id="debug-division-enabled" checked></label>
          <span>Division: <span id="debug-division">1.0</span></span>
          <button onclick="adjustDifficulty(-1, '÷')" class="debug-btn-sm">-</button>
          <button onclick="adjustDifficulty(1, '÷')" class="debug-btn-sm">+</button>
        </div>
        <div><span id="debug-delta"></span></div>
        <div id="debug-modifiers" class="debug-modifiers"></div>
        <div class="debug-controls">
          <label><input type="checkbox" id="debug-freeze-level"> Freeze levels</label>
        </div>
        <div class="debug-controls debug-force-modifiers">
          <span>Force:</span>
          <label><input type="checkbox" id="debug-force-easy"> easy</label>
          <label><input type="checkbox" id="debug-force-hard"> hard</label>
          <label><input type="checkbox" id="debug-force-3nums"> 3 nums</label>
          <label><input type="checkbox" id="debug-force-x2"> x2</label>
          <label><input type="checkbox" id="debug-force-round"> round</label>
          <label><input type="checkbox" id="debug-force-negative"> negative</label>
        </div>
        <div class="debug-controls">
          <button onclick="endGame()" class="debug-btn">End Game</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let score = 0;
    let timeLeft = 30;
    let timer = null;
    let numbers = [];
    let correctAnswer = 0;
    let currentOperation = '+';
    let additionDifficulty = parseFloat(localStorage.getItem('additionLevel')) || 1.0;
    let subtractionDifficulty = parseFloat(localStorage.getItem('subtractionLevel')) || 1.0;
    let multiplicationDifficulty = parseFloat(localStorage.getItem('multiplicationLevel')) || 1.0;
    let divisionDifficulty = parseFloat(localStorage.getItem('divisionLevel')) || 1.0;
    let topScores = JSON.parse(localStorage.getItem('topScores')) || [];
    let totalPuzzlesSolved = parseInt(localStorage.getItem('totalPuzzlesSolved')) || 0;
    let keyBindings = JSON.parse(localStorage.getItem('keyBindings')) || {};
    let startingAdditionDifficulty = additionDifficulty;
    let startingSubtractionDifficulty = subtractionDifficulty;
    let startingMultiplicationDifficulty = multiplicationDifficulty;
    let startingDivisionDifficulty = divisionDifficulty;
    let currentPuzzleDifficulty = 1.0;
    let isEasyProblem = false;
    let hardMultiplier = 1;
    let activeModifiers = [];
    let problemStartTime = 0;
    let DEBUG = localStorage.getItem('debugMode') === 'true';
    let highestLevel = parseInt(localStorage.getItem('highestLevel')) || 0;
    let gameResponseTimes = [];
    let previousAnswer = null;
    const TARGET_TIME = 4;
    const GAME_DURATION = 60;

    const _t = [
      [0, 'bm9vYg=='],
      [10, 'c2VucGFp'],
      [15, 'c2Vuc2Vp'],
      [20, 'Z2VuaXVz'],
      [30, 'Z2FsYXh5IGJyYWlu'],
      [40, 'd2l6YXJk'],
      [50, 'bWVudGF0']
    ];
    const _d = s => atob(s);

    function getTitle(level) {
      for (let i = _t.length - 1; i >= 0; i--) {
        if (level >= _t[i][0]) return _d(_t[i][1]);
      }
      return _d(_t[0][1]);
    }

    function handleKeyBinding(event) {
      const key = event.key.toLowerCase();
      if (keyBindings[key]) {
        event.preventDefault();
        const input = document.getElementById('answer');
        if (keyBindings[key] === 'backspace') {
          input.value = input.value.slice(0, -1);
        } else {
          input.value += keyBindings[key];
          checkAnswer();
        }
      }
    }

    function getAverageLevel() {
      return (additionDifficulty + subtractionDifficulty + multiplicationDifficulty + divisionDifficulty) / 4;
    }

    function getCurrentDifficulty() {
      switch (currentOperation) {
        case '+': return additionDifficulty;
        case '-': return subtractionDifficulty;
        case '×': return multiplicationDifficulty;
        case '÷': return divisionDifficulty;
        default: return additionDifficulty;
      }
    }

    // Initialize level display
    updateLevelDisplay();
    updateHighScoreDisplay();

    function getHighScore() {
      return topScores.length > 0 ? topScores[0].score : 0;
    }

    function updateHighScoreDisplay() {
      document.getElementById('high-score-value').textContent = getHighScore();
    }

    function addScore(newScore) {
      topScores.push({ score: newScore, date: Date.now() });
      topScores.sort((a, b) => b.score - a.score);
      topScores = topScores.slice(0, 10);
      localStorage.setItem('topScores', JSON.stringify(topScores));
      updateHighScoreDisplay();
    }

    function startGame() {
      score = 0;
      timeLeft = 60;
      gameResponseTimes = [];
      previousAnswer = null;
      startingAdditionDifficulty = additionDifficulty;
      startingSubtractionDifficulty = subtractionDifficulty;
      startingMultiplicationDifficulty = multiplicationDifficulty;
      startingDivisionDifficulty = divisionDifficulty;

      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');

      document.getElementById('score').textContent = score;
      document.getElementById('timer-progress').style.transition = 'width 1s linear';
      updateTimerBar();

      // Debug panel visibility
      document.getElementById('debug-panel').classList.toggle('hidden', !DEBUG);
      updateDebug();

      generateProblem();
      document.getElementById('answer').focus();

      if (!DEBUG) {
        timer = setInterval(() => {
          timeLeft--;
          updateTimerBar();

          if (timeLeft <= 0) {
            endGame();
          }
        }, 1000);
      }
    }

    function generateProblem() {
      // Randomly pick operation (respecting debug filters)
      const addEnabled = !DEBUG || document.getElementById('debug-addition-enabled').checked;
      const subEnabled = !DEBUG || document.getElementById('debug-subtraction-enabled').checked;
      const mulEnabled = !DEBUG || document.getElementById('debug-multiplication-enabled').checked;
      const divEnabled = !DEBUG || document.getElementById('debug-division-enabled').checked;

      const enabledOps = [];
      if (addEnabled) enabledOps.push('+');
      if (subEnabled) enabledOps.push('-');
      if (mulEnabled) enabledOps.push('×');
      if (divEnabled) enabledOps.push('÷');

      if (enabledOps.length === 0) {
        currentOperation = '+'; // fallback
      } else {
        currentOperation = enabledOps[Math.floor(Math.random() * enabledOps.length)];
      }
      const difficulty = getCurrentDifficulty();

      // Reset modifiers
      activeModifiers = [];

      // 10% chance of easy problem (half current difficulty)
      // 10% chance of hard problem (2-5x current difficulty) - mutually exclusive with easy
      const forceEasy = DEBUG && document.getElementById('debug-force-easy').checked;
      const forceHard = DEBUG && document.getElementById('debug-force-hard').checked;
      isEasyProblem = forceEasy || (!forceHard && Math.random() < 0.1);
      const isHardProblem = forceHard || (!isEasyProblem && Math.random() < 0.1);
      hardMultiplier = isHardProblem ? Math.floor(Math.random() * 4) + 2 : 1; // 2-5x

      if (isEasyProblem) {
        currentPuzzleDifficulty = Math.max(1, difficulty / 2);
        activeModifiers.push('easy');
      } else if (isHardProblem) {
        currentPuzzleDifficulty = difficulty * hardMultiplier;
        activeModifiers.push('hard ' + hardMultiplier + 'x');
      } else {
        currentPuzzleDifficulty = difficulty;
      }

      // Number scaling differs by operation type
      let minNum, maxNum;
      if (currentOperation === '×') {
        // Multiplication uses smaller numbers
        minNum = 2 + Math.floor(currentPuzzleDifficulty / 3);
        maxNum = 4 + Math.floor(currentPuzzleDifficulty / 2);
      } else if (currentOperation === '÷') {
        // Division uses even smaller numbers (division is cognitively harder)
        minNum = 2 + Math.floor(currentPuzzleDifficulty / 5);
        maxNum = 3 + Math.floor(currentPuzzleDifficulty / 3);
      } else {
        // Addition/subtraction
        minNum = 1 + Math.floor(currentPuzzleDifficulty);
        maxNum = 5 + Math.floor(currentPuzzleDifficulty * 2);
      }

      // Generate first number (scales with difficulty)
      let num1 = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;

      // Second number: multiplication/division use minNum, addition/subtraction start at 1
      let num2;
      if (currentOperation === '×' || currentOperation === '÷') {
        num2 = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
      } else {
        num2 = Math.floor(Math.random() * maxNum) + 1;
      }

      numbers = [num1, num2];

      const force3Nums = DEBUG && document.getElementById('debug-force-3nums').checked;
      const forceX2 = DEBUG && document.getElementById('debug-force-x2').checked;
      const forceRound = DEBUG && document.getElementById('debug-force-round').checked;
      const forceNegative = DEBUG && document.getElementById('debug-force-negative').checked;

      if (currentOperation === '+') {
        // 10% chance: three-number problem
        if (force3Nums || Math.random() < 0.1) {
          const num3 = Math.floor(Math.random() * maxNum) + 1;
          numbers.push(num3);
          activeModifiers.push('3 nums');
        }
        // 10% chance: challenge multiplier (double one number)
        if (forceX2 || Math.random() < 0.1) {
          const idx = Math.floor(Math.random() * numbers.length);
          numbers[idx] = numbers[idx] * 2;
          activeModifiers.push('x2');
        }

        // 10% chance: round number anchor (replace one number with round number)
        if (forceRound || Math.random() < 0.1) {
          const roundNumbers = [10, 20, 25, 50, 100].filter(n => n <= maxNum * 2);
          if (roundNumbers.length > 0) {
            const idx = Math.floor(Math.random() * numbers.length);
            numbers[idx] = roundNumbers[Math.floor(Math.random() * roundNumbers.length)];
            activeModifiers.push('round');
          }
        }

        correctAnswer = numbers.reduce((sum, n) => sum + n, 0);
        document.getElementById('problem-text').textContent = numbers.join(' + ');

      } else if (currentOperation === '-') {
        // Subtraction: generate answer first, then construct problem
        const targetAnswer = Math.floor(Math.random() * (maxNum * 2 - minNum + 1)) + minNum;

        // Generate the number we subtract
        num2 = Math.floor(Math.random() * maxNum) + 1;

        // Calculate num1 to produce the target answer
        num1 = targetAnswer + num2;

        numbers = [num1, num2];

        // 10% chance: three-number problem
        if (force3Nums || Math.random() < 0.1) {
          const num3 = Math.floor(Math.random() * maxNum) + 1;
          numbers.push(num3);
          activeModifiers.push('3 nums');
        }

        // 10% chance: challenge multiplier (double one number)
        if (forceX2 || Math.random() < 0.1) {
          const idx = Math.floor(Math.random() * numbers.length);
          numbers[idx] = numbers[idx] * 2;
          activeModifiers.push('x2');
        }

        // 10% chance: round number anchor
        if (forceRound || Math.random() < 0.1) {
          const roundNumbers = [10, 20, 25, 50, 100].filter(n => n <= maxNum * 2);
          if (roundNumbers.length > 0) {
            const idx = Math.floor(Math.random() * numbers.length);
            numbers[idx] = roundNumbers[Math.floor(Math.random() * roundNumbers.length)];
            activeModifiers.push('round');
          }
        }

        // 10% chance: negative result
        const allowNegative = forceNegative || Math.random() < 0.1;
        const subtractTotal = numbers.slice(1).reduce((sum, n) => sum + n, 0);

        if (allowNegative) {
          activeModifiers.push('negative');
          // Ensure negative result
          if (numbers[0] >= subtractTotal) {
            numbers[0] = Math.max(1, subtractTotal - Math.floor(Math.random() * maxNum) - 1);
          }
        } else {
          // Ensure positive result
          if (numbers[0] <= subtractTotal) {
            numbers[0] = subtractTotal + Math.floor(Math.random() * maxNum) + 1;
          }
        }
        correctAnswer = numbers[0] - subtractTotal;
        document.getElementById('problem-text').textContent = numbers[0] + ' - ' + numbers.slice(1).join(' - ');

      } else if (currentOperation === '×') {
        // Multiplication
        correctAnswer = num1 * num2;
        numbers = [num1, num2];
        document.getElementById('problem-text').textContent = num1 + ' × ' + num2;

      } else if (currentOperation === '÷') {
        // Division: generate answer and divisor, compute dividend
        const answer = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
        const divisor = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
        const dividend = answer * divisor;

        numbers = [dividend, divisor];
        correctAnswer = answer;
        document.getElementById('problem-text').textContent = dividend + ' ÷ ' + divisor;
      }

      // Avoid same answer twice in a row
      if (correctAnswer === previousAnswer) {
        generateProblem();
        return;
      }
      previousAnswer = correctAnswer;

      document.getElementById('answer').value = '';
      problemStartTime = Date.now();
      updateDebugModifiers();
    }

    function updateDebugModifiers() {
      if (!DEBUG) return;
      const el = document.getElementById('debug-modifiers');
      if (activeModifiers.length === 0) {
        el.textContent = '';
      } else {
        el.textContent = '[' + activeModifiers.join('] [') + ']';
      }
    }

    function checkAnswer() {
      const answer = parseInt(document.getElementById('answer').value);
      if (answer === correctAnswer) {
        const elapsed = (Date.now() - problemStartTime) / 1000;
        const difficulty = getCurrentDifficulty();
        const points = Math.floor(difficulty) * hardMultiplier;
        const puzzleText = document.getElementById('problem-text').textContent;
        gameResponseTimes.push({ time: elapsed, puzzle: puzzleText, points: points });

        // Smooth difficulty adjustment (target time scales with hard multiplier)
        const adjustedTargetTime = TARGET_TIME * hardMultiplier;
        const timeDelta = elapsed - adjustedTargetTime; // negative = fast, positive = slow
        const timeMultiplier = Math.max(-1, Math.min(1, -timeDelta / 3));
        // Scale adjustments higher at low levels (1.9x at level 1, 1x at level 10+)
        const levelMultiplier = Math.max(1, 1 + (10 - difficulty) / 10);
        let delta = 0.25 * timeMultiplier * levelMultiplier;

        // Easy problems never increase difficulty
        if (isEasyProblem && delta > 0) {
          delta = 0;
        }

        // Debug: freeze levels
        if (DEBUG && document.getElementById('debug-freeze-level').checked) {
          delta = 0;
        }

        // Apply delta to correct difficulty
        switch (currentOperation) {
          case '+':
            additionDifficulty = Math.max(1.0, additionDifficulty + delta);
            break;
          case '-':
            subtractionDifficulty = Math.max(1.0, subtractionDifficulty + delta);
            break;
          case '×':
            multiplicationDifficulty = Math.max(1.0, multiplicationDifficulty + delta);
            break;
          case '÷':
            divisionDifficulty = Math.max(1.0, divisionDifficulty + delta);
            break;
        }
        updateDebug(delta);

        // Score based on difficulty (scaled by hard multiplier)
        score += points;
        document.getElementById('score').textContent = score;

        // Track total puzzles solved
        totalPuzzlesSolved++;

        generateProblem();
      }
    }

    let debugDeltaTimeout = null;

    function updateDebug(delta = null) {
      if (!DEBUG) return;
      document.getElementById('debug-addition').textContent = additionDifficulty.toFixed(1);
      document.getElementById('debug-subtraction').textContent = subtractionDifficulty.toFixed(1);
      document.getElementById('debug-multiplication').textContent = multiplicationDifficulty.toFixed(1);
      document.getElementById('debug-division').textContent = divisionDifficulty.toFixed(1);

      if (delta !== null && delta !== 0) {
        const deltaEl = document.getElementById('debug-delta');
        const sign = delta > 0 ? '+' : '';
        deltaEl.textContent = '(' + currentOperation + ') ' + sign + delta.toFixed(2);
        deltaEl.classList.add('visible');

        clearTimeout(debugDeltaTimeout);
        debugDeltaTimeout = setTimeout(() => {
          deltaEl.classList.remove('visible');
        }, 800);
      }
    }

    function updateLevelDisplay() {
      const level = Math.floor(getAverageLevel());
      document.getElementById('current-level').textContent = level;
      document.getElementById('current-title').textContent = '(' + getTitle(level) + ')';

      // Track highest level achieved
      if (level > highestLevel) {
        highestLevel = level;
        localStorage.setItem('highestLevel', highestLevel);
      }
    }

    function toggleTitlePopup() {
      renderTitleTable();
      document.getElementById('title-popup').classList.toggle('hidden');
    }

    function renderTitleTable() {
      const ranges = ['0-9', '10-14', '15-19', '20-29', '30-39', '40-49', '50+'];
      const table = document.getElementById('title-table');
      table.innerHTML = _t.map((t, i) => {
        const unlocked = highestLevel >= t[0];
        const name = unlocked ? _d(t[1]) : '???';
        const cls = unlocked ? '' : 'locked';
        return `<tr class="${cls}"><td class="title-level">${ranges[i]}</td><td>${name}</td></tr>`;
      }).join('');
    }

    function updateTimerBar() {
      const percentage = (timeLeft / GAME_DURATION) * 100;
      document.getElementById('timer-progress').style.width = percentage + '%';
    }

    function adjustDifficulty(amount, op) {
      switch (op) {
        case '+':
          additionDifficulty = Math.max(1.0, additionDifficulty + amount);
          break;
        case '-':
          subtractionDifficulty = Math.max(1.0, subtractionDifficulty + amount);
          break;
        case '×':
          multiplicationDifficulty = Math.max(1.0, multiplicationDifficulty + amount);
          break;
        case '÷':
          divisionDifficulty = Math.max(1.0, divisionDifficulty + amount);
          break;
      }
      updateDebug();
      document.getElementById('answer').focus();
    }

    function endGame() {
      clearInterval(timer);
      localStorage.setItem('additionLevel', additionDifficulty.toFixed(2));
      localStorage.setItem('subtractionLevel', subtractionDifficulty.toFixed(2));
      localStorage.setItem('multiplicationLevel', multiplicationDifficulty.toFixed(2));
      localStorage.setItem('divisionLevel', divisionDifficulty.toFixed(2));
      updateLevelDisplay();

      // Show level change (whole numbers only, based on average)
      const oldLevel = Math.floor((startingAdditionDifficulty + startingSubtractionDifficulty + startingMultiplicationDifficulty + startingDivisionDifficulty) / 4);
      const newLevel = Math.floor(getAverageLevel());
      const levelDelta = newLevel - oldLevel;
      const deltaEl = document.getElementById('level-delta');
      if (levelDelta !== 0) {
        const sign = levelDelta > 0 ? '+' : '';
        deltaEl.textContent = sign + levelDelta;
        deltaEl.className = levelDelta > 0 ? 'delta-up' : 'delta-down';
      } else {
        deltaEl.textContent = '';
      }

      // Save stats
      localStorage.setItem('totalPuzzlesSolved', totalPuzzlesSolved);
      const oldHighScore = getHighScore();
      const isNewRecord = !DEBUG && score > oldHighScore && score > 0;
      if (!DEBUG) {
        addScore(score);
      }

      const timerEl = document.getElementById('timer-progress');
      timerEl.style.transition = 'none';
      timerEl.style.width = '100%';
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
      document.getElementById('last-score-value').textContent = score;
      document.getElementById('last-score').classList.remove('hidden');

      // Show "New record!" if this is a new high score (only in non-debug mode)
      const newRecordEl = document.getElementById('new-record');
      if (isNewRecord) {
        newRecordEl.classList.remove('hidden');
      } else {
        newRecordEl.classList.add('hidden');
      }

      renderStatsChart();
    }

    function toggleStatsPopup() {
      document.getElementById('stats-popup').classList.toggle('hidden');
    }

    function renderStatsChart() {
      const chart = document.getElementById('stats-chart');
      if (gameResponseTimes.length === 0) {
        chart.textContent = 'No data';
        return;
      }

      const times = gameResponseTimes.map(p => p.time);
      const maxTime = Math.max(...times);
      const barWidth = 20;
      const lines = gameResponseTimes.map((p, i) => {
        const width = Math.round((p.time / maxTime) * barWidth);
        const bar = '█'.repeat(width) + '░'.repeat(barWidth - width);
        const puzzle = p.puzzle.padEnd(15);
        return `${puzzle} ${bar} ${p.time.toFixed(1)}s  +${p.points}`;
      });

      // Add summary
      const totalPoints = gameResponseTimes.reduce((sum, p) => sum + p.points, 0);
      const avg = times.reduce((a, b) => a + b, 0) / times.length;
      const fast = times.filter(t => t <= TARGET_TIME).length;
      lines.push('');
      lines.push(`avg: ${avg.toFixed(1)}s | fast: ${fast}/${gameResponseTimes.length} | total: ${totalPoints} points`);

      chart.textContent = lines.join('\n');
    }
  </script>
</body>
</html>
