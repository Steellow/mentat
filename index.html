<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mental Math</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Mental Math</h1>

    <div id="start-screen">
      <p>Solve as many addition problems as you can in 30 seconds.</p>
      <p class="level">Level: <span id="current-level">1</span> <span id="level-delta"></span></p>
      <p id="last-score" class="last-score hidden">Last score: <span id="last-score-value">0</span></p>
      <button onclick="startGame()">Start</button>
    </div>

    <div id="game-screen" class="hidden">
      <div class="timer hidden">Time: <span id="time">30</span>s</div>
      <div class="problem"><span id="problem-text">0 + 0</span> = ?</div>
      <input type="number" id="answer" autofocus oninput="checkAnswer()">
      <div class="score">Score: <span id="score">0</span></div>
      <div id="debug-panel" class="debug">
        <span class="debug-label">DEBUG</span>
        <div>Difficulty: <span id="debug-difficulty">1.0</span> <span id="debug-delta"></span></div>
        <div class="debug-controls">
          <button onclick="adjustDifficulty(-1)" class="debug-btn">-1</button>
          <button onclick="adjustDifficulty(1)" class="debug-btn">+1</button>
          <button onclick="endGame()" class="debug-btn">End Game</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let score = 0;
    let timeLeft = 30;
    let timer = null;
    let numbers = [];
    let correctAnswer = 0;
    let difficulty = parseFloat(localStorage.getItem('mathLevel')) || 1.0;
    let startingDifficulty = difficulty;
    let currentPuzzleDifficulty = 1.0;
    let problemStartTime = 0;
    const DEBUG = true;
    const TARGET_TIME = 4;

    // Initialize level display
    updateLevelDisplay();

    function startGame() {
      score = 0;
      timeLeft = 30;
      startingDifficulty = difficulty;

      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');

      document.getElementById('score').textContent = score;
      document.getElementById('time').textContent = timeLeft;

      // Debug panel visibility
      document.getElementById('debug-panel').classList.toggle('hidden', !DEBUG);
      updateDebug();

      generateProblem();
      document.getElementById('answer').focus();

      if (!DEBUG) {
        timer = setInterval(() => {
          timeLeft--;
          document.getElementById('time').textContent = timeLeft;

          if (timeLeft <= 0) {
            endGame();
          }
        }, 1000);
      }
    }

    function generateProblem() {
      // 10% chance of easy problem
      const isEasyProblem = Math.random() < 0.1;
      currentPuzzleDifficulty = isEasyProblem ? 1.0 : difficulty;

      const minNum = 1 + Math.floor(currentPuzzleDifficulty);
      const maxNum = 5 + Math.floor(currentPuzzleDifficulty * 2);

      // Generate first number (scales with difficulty)
      let num1 = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;

      // Second number has wider range (1 to max)
      let num2 = Math.floor(Math.random() * maxNum) + 1;

      numbers = [num1, num2];

      // 10% chance: three-number addition
      if (Math.random() < 0.1) {
        const num3 = Math.floor(Math.random() * maxNum) + 1;
        numbers.push(num3);
      }

      // 10% chance: challenge multiplier (double one number)
      if (Math.random() < 0.1) {
        const idx = Math.floor(Math.random() * numbers.length);
        numbers[idx] = numbers[idx] * 2;
      }

      // 10% chance: round number anchor (replace one number with round number)
      if (Math.random() < 0.1) {
        const roundNumbers = [10, 20, 25, 50, 100].filter(n => n <= maxNum * 2);
        if (roundNumbers.length > 0) {
          const idx = Math.floor(Math.random() * numbers.length);
          numbers[idx] = roundNumbers[Math.floor(Math.random() * roundNumbers.length)];
        }
      }

      correctAnswer = numbers.reduce((sum, n) => sum + n, 0);
      document.getElementById('problem-text').textContent = numbers.join(' + ');
      document.getElementById('answer').value = '';

      problemStartTime = Date.now();
    }

    function checkAnswer() {
      const answer = parseInt(document.getElementById('answer').value);
      if (answer === correctAnswer) {
        const elapsed = (Date.now() - problemStartTime) / 1000;

        // Smooth difficulty adjustment
        const puzzleRatio = currentPuzzleDifficulty / difficulty;
        const timeDelta = elapsed - TARGET_TIME; // negative = fast, positive = slow
        const timeMultiplier = Math.max(-1, Math.min(1, -timeDelta / 3));
        const baseAdjustment = 0.25 * timeMultiplier;

        const oldDifficulty = difficulty;
        if (baseAdjustment > 0) {
          // Only increase difficulty if puzzle was at least half current difficulty
          if (puzzleRatio >= 0.5) {
            difficulty = difficulty + baseAdjustment * puzzleRatio;
          }
        } else {
          // Always allow decreases
          difficulty = Math.max(1.0, difficulty + baseAdjustment);
        }
        updateDebug(difficulty - oldDifficulty);

        // Score based on difficulty
        score += Math.floor(difficulty);
        document.getElementById('score').textContent = score;

        generateProblem();
      }
    }

    let debugDeltaTimeout = null;

    function updateDebug(delta = null) {
      if (!DEBUG) return;
      document.getElementById('debug-difficulty').textContent = difficulty.toFixed(1);

      if (delta !== null && delta !== 0) {
        const deltaEl = document.getElementById('debug-delta');
        const sign = delta > 0 ? '+' : '';
        deltaEl.textContent = sign + delta.toFixed(2);
        deltaEl.classList.add('visible');

        clearTimeout(debugDeltaTimeout);
        debugDeltaTimeout = setTimeout(() => {
          deltaEl.classList.remove('visible');
        }, 800);
      }
    }

    function updateLevelDisplay() {
      document.getElementById('current-level').textContent = Math.floor(difficulty);
    }

    function adjustDifficulty(amount) {
      const oldDifficulty = difficulty;
      difficulty = Math.max(1.0, difficulty + amount);
      updateDebug(difficulty - oldDifficulty);
      generateProblem();
      document.getElementById('answer').focus();
    }

    function endGame() {
      clearInterval(timer);
      localStorage.setItem('mathLevel', difficulty.toFixed(2));
      updateLevelDisplay();

      // Show level change (whole numbers only)
      const oldLevel = Math.floor(startingDifficulty);
      const newLevel = Math.floor(difficulty);
      const levelDelta = newLevel - oldLevel;
      const deltaEl = document.getElementById('level-delta');
      if (levelDelta !== 0) {
        const sign = levelDelta > 0 ? '+' : '';
        deltaEl.textContent = sign + levelDelta;
        deltaEl.className = levelDelta > 0 ? 'delta-up' : 'delta-down';
      } else {
        deltaEl.textContent = '';
      }

      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
      document.getElementById('last-score-value').textContent = score;
      document.getElementById('last-score').classList.remove('hidden');
    }
  </script>
</body>
</html>
